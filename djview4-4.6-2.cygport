DESCRIPTION="DjVu document viewer and browser plugin"
HOMEPAGE="http://djvulibre.djvuzone.org/"
SRC_URI="mirror://sourceforge/djvu/${P}.tar.gz"

PATCH_URI="
	mirror://portage/app-text/${PN}/files/${P}-segfault.patch
	4.5-nsdejavu-weak-symbols.patch
"

DISTCLEANFILES="aclocal.m4 config/l*.m4"
ACLOCAL_FLAGS="-I config"

src_compile() {
	cd ${S}
	cygautoreconf

	cd ${B}
	# force use of GLib mainloop instead of Xt
	# http://bugs.gentoo.org/245841
	cygconf --with-tiff --disable-desktopfiles ac_cv_header_X11_Shell_h=no

	cygmake plugindir=/usr/lib/mozilla/plugins \
            NSDEJAVU_LIBS="-avoid-version -no-undefined -lglib-2.0 -lX11"
}

src_install() {
	cd ${B}
	cyginstall plugindir=/usr/lib/mozilla/plugins

	for i in 32 64
	do
		insinto /usr/share/icons/hicolor/${i}x${i}/apps
		newins desktopfiles/hi${i}-djview4.png djvulibre-djview4.png
	done

	insinto /usr/share/icons/hicolor/scalable/apps
	newins desktopfiles/hi-djview4.svgz djvulibre-djview4.svgz

	domenu ${S}/desktopfiles/djvulibre-djview4.desktop
}
